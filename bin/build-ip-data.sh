#!/bin/bash
# ==============================================================================
# Build IP-to-Country PHP Data
# ==============================================================================
# This script processes the IP2Location LITE DB1 CSV file and converts it
# into a PHP associative array suitable for quick lookups.
#
# Usage:
#   Run this script from the plugin's root directory.
#   ./bin/build-ip-data.sh
# ==============================================================================

# Configuration
CSV_FILE="./bin/ip_to_country.csv"
PHP_OUTPUT_FILE="./includes/GeoIP/data/ip_to_country.php"

# Check if CSV file exists
if [ ! -f "$CSV_FILE" ]; then
    echo "ERROR: IP-to-Country CSV file not found at: $CSV_FILE" >&2
    echo "Please download IP2Location Lite DB1 (IPV4) CSV from https://lite.ip2location.com/database/ip-to-country" >&2
    echo "and place it as '$CSV_FILE'." >&2
    exit 1
fi

echo "INFO: Processing '$CSV_FILE' to generate '$PHP_OUTPUT_FILE'..."

# Start PHP array file
echo "<?php" > "$PHP_OUTPUT_FILE"
echo "/**" >> "$PHP_OUTPUT_FILE"
echo " * IP-to-Country Data." >> "$PHP_OUTPUT_FILE"
echo " *" >> "$PHP_OUTPUT_FILE"
echo " * AUTO-GENERATED by bin/build-ip-data.sh. DO NOT EDIT MANUALLY." >> "$PHP_OUTPUT_FILE"
echo " */" >> "$PHP_OUTPUT_FILE"
echo "" >> "$PHP_OUTPUT_FILE"
echo "if ( ! defined( 'ABSPATH' ) ) { exit; }" >> "$PHP_OUTPUT_FILE"
echo "" >> "$PHP_OUTPUT_FILE"
echo "return [" >> "$PHP_OUTPUT_FILE"

# Read CSV, skip header, and process each line
# Format: "ip_from","ip_to","country_code","country_name"
# We only care about ip_from, ip_to, and country_code
tail -n +2 "$CSV_FILE" | while IFS=, read -r ip_from ip_to country_code country_name; do
    # Remove quotes
    ip_from=$(echo "$ip_from" | tr -d '"')
    ip_to=$(echo "$ip_to" | tr -d '"')
    country_code=$(echo "$country_code" | tr -d '"')

    # Ensure valid data
    if [[ -n "$ip_from" && -n "$ip_to" && -n "$country_code" ]]; then
        echo "    ['$ip_from', '$ip_to', '$country_code']," >> "$PHP_OUTPUT_FILE"
    fi
done

# Close PHP array
echo "];" >> "$PHP_OUTPUT_FILE"

echo "INFO: Successfully generated '$PHP_OUTPUT_FILE'."